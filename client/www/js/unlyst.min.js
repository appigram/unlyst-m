var starter=angular.module("starter",["ionic","starter.routes","starter.controllers","starter.services","starter.filters","starter.directives","ui.router","firebase","leaflet-directive","xeditable","angulartics","angulartics.google.analytics","ngMaterial"]),starterControllers=angular.module("starter.controllers",[]);starter.config(function(e){e.interceptors.push(function(e){return{request:function(o){return e.$broadcast("loading:show"),o},response:function(o){return e.$broadcast("loading:hide"),o}}})}).run(function(e,o,a){e.$on("loading:show",function(){o.show({content:"Loading",animation:"fade-in",showBackdrop:!0,maxWidth:200,showDelay:0})}),e.$on("loading:hide",function(){o.hide()}),e.notify=function(e,o){a.alert({title:e?e:"Error",template:o})},e.hide=function(){o.hide()},e.show=function(a){e.loading=o.show({template:'<i class="icon ion-looping"></i><br>'+a,animation:"fade-in",showBackdrop:!0,maxWidth:200,showDelay:0})}}).config(function(e){e.theme("default").primaryColor("blue")}).run(function(e){e.ready(function(){window.cordova&&window.cordova.plugins.Keyboard&&cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),window.StatusBar&&StatusBar.styleDefault(),"undefined"!=typeof analytics?analytics.startTrackerWithId("UA-57937417-1"):console.log("Google Analytics Unavailable for IOS/Android")})}),angular.module("starter.directives",[]).directive("noScroll",function(e){return{restrict:"A",link:function(){e.on("touchmove",function(e){e.preventDefault()})}}}),angular.module("starter.filters",[]).filter("noFractionCurrency",["$filter","$locale",function(e,o){var a=e("currency"),t=o.NUMBER_FORMATS;return function(e,o){var r=a(e,o),n=r.indexOf(t.DECIMAL_SEP);return e>=0?r.substring(0,n):r.substring(0,n)+")"}}]).filter("scoreMessage",[function(){return function(e){var o=["Sorry, we can’t count that estimate","Are you even trying?","Yikes, you’re way off","Think of this as a learning round","Don’t get out much?","You’ve got it in you!","Okay, you’re getting the hang of this","A solid valuation","You’re a star","That was so close!","Nailed it!"],a=Math.round(e);return o[a]}}]),angular.module("starter.routes",[]).config(function(e,o){e.state("home",{url:"/",templateUrl:"view/buyer/home.html",controller:"HomeCtrl"}).state("login",{url:"/login",templateUrl:"view/user/login.html",controller:"LoginCtrl"}).state("register",{url:"/register",templateUrl:"view/user/register.html",controller:"RegisterCtrl"}).state("addHome",{url:"/addHome",templateUrl:"view/seller/addhome.html",controller:"AddHomeCtrl"}).state("addHome.addHome1",{url:"/addHome1",templateUrl:"view/seller/addhome1.html"}).state("addHome.addHome2",{url:"/addHome2",templateUrl:"view/seller/addhome2.html"}).state("addHome.addHome3",{url:"/addHome3",templateUrl:"view/seller/addhome3.html"}),o.otherwise("/")}),angular.module("starter.services",[]).factory("fireBaseData",["$firebase",function(){var e,o,a,t="https://fiery-heat-1976.firebaseio.com";e="https://fiery-heat-1976.firebaseio.com/unlyst/",o="https://fiery-heat-1976.firebaseio.com/valuations-prod",a="https://fiery-heat-1976.firebaseio.com/user/",e="https://fiery-heat-1976.firebaseio.com/unlyst-test/",o="https://fiery-heat-1976.firebaseio.com/valuations",a="https://fiery-heat-1976.firebaseio.com/user-test/";var r=new Firebase(t),n=new Firebase(e),i=new Firebase(o),l=new Firebase(a);return{ref:function(){return r},refValuation:function(){return i},refHomes:function(){return n},refUsers:function(){return l},saveValuation:function(e,o,a){if(null!=l&&null!=o){null==o.reputation&&(o.reputation=0);var t=100-100*Math.abs((a.crowdvalue-e)/a.crowdvalue);0>t&&(t=0);var e={created:Firebase.ServerValue.TIMESTAMP,homeID:a.$id,homeValue:a.crowdvalue,homeReputation:a.totalReputation,userID:o.uid,userSubmittedValue:parseInt(e),userReputation:o.reputation,accuracy:t};console.log(t);var r=a.totalReputation+t,u=1.1,s=1.2,c=70,d=100,m=t-c;c-100>m&&(m=c-100);var p=o.reputation?Math.pow(u,o.reputation/s)+m:m;u>p&&(p=u);var h=Math.log(p)/Math.log(u)*s;return h>d&&(h=d),console.log("old reputation: "+o.reputation),console.log("user new reputation: "+h),i.push(e),l.child(o.uid+"/valuations").push(e),l.child(o.uid+"/reputation").set(h),n.child(a.$id+"/valuations").push(e),n.child(a.$id+"/totalReputation").set(r),1}}}}]).factory("utility",[function(){return{shuffle:function(e){for(var o,a,t=e.length;0!==t;)a=Math.floor(Math.random()*t),t-=1,o=e[t],e[t]=e[a],e[a]=o;return e},defaultCondoValue:function(e){return 500*e},maxCondoValue:function(e){return 1e3*e>1e6?1e3*e:1e6}}}]).factory("geocoding",[function(){var e=new google.maps.Geocoder,o="Toronto",a=function(a){return function(t,r){t=t+", "+o,console.log("address: "+t),e.geocode({address:t},function(e,o){var t;o==google.maps.GeocoderStatus.OK?t=a(e):console.log(o),"function"==typeof r&&r(t)})}},t=function(e){for(var o,a,t=e[0].geometry.location,r=e[0].address_components,n=0;n<r.length;n+=1)r[n].types.indexOf("neighborhood")>=0&&(a=r[n].long_name),r[n].types.indexOf("postal_code")>=0&&(o=r[n].long_name);return{lat:t.lat(),lng:t.lng(),postal_code:o,neighborhood:a,full_address:e[0].formatted_address}};return{getData:a(t)}}]).factory("homeSchema",[function(){var e={homeTypes:[{name:"Condominium",value:"condominium"},{name:"Semi-datached House",value:"semiHouse"},{name:"Detached House",value:"detachedHouse"},{name:"Townhouse",value:"townHouse"}],buildingTypes:[{name:"High-rise",value:"highRise"},{name:"Mid-rise",value:"midRise"},{name:"Low-rise",value:"lowRise"}],bedRooms:[0,1,2,3,4],bathRooms:[0,1,2,3,4],additionalSpace:["Den","study","Sunroom","Storage locker"],parkingType:[{name:"n/a",value:"na"},{name:"Underground Garage",value:"underGroundGrg"},{name:"Above Ground Garage",value:"AboveGroundGrg"},{name:"Driveway",value:"driveway"}],parkingSpace:[0,1,2,3,4],outdoorSpace:[{name:"Balcony",value:"balcony"},{name:"Terrace",value:"terrace"},{name:"Juliet balcony",value:"julietBalcony"}],orientation:["North","East","South","West"],amenity:[{name:"Pool",value:"pool"},{name:"Gym",value:"gym"},{name:"Sauna",value:"sauna"},{name:"Steam",value:"steam"},{name:"Spa",value:"spa"},{name:"Rooftop",value:"rooftop"},{name:"BBQ",value:"bbq"},{name:"Pet Wash",value:"petWash"},{name:"Concierge(24 hour)",value:"conciergeFullTime"},{name:"Concierge(Part-time)",value:"conciergePartTime"},{name:"Party Room",value:"partyRoom"}],lat:0,lng:0};return e}]),starterControllers.controller("HeaderCtrl",function(e,o,a,t,r,n){o.authData=a.ref().getAuth(),o.getUserDisplayName=function(){return null===o.authData?null:"google"===o.authData.provider?o.authData.google.displayName.split(" ")[0]:"facebook"===o.authData.provider?o.userDisplayName=o.authData.facebook.displayName.split(" ")[0]:"twitter"===o.authData.provider?o.authData.twitter.displayName.split(" ")[0]:"password"===o.authData.provider?null==o.authData.user?"":o.authData.user.firstname:void 0},t.fromTemplateUrl("view/user/popover.html",{scope:e}).then(function(o){e.popover=o}),o.logout=function(){r.clearCache(),a.ref().unauth(),o.checkSession(),o.notify("Logged out successfully!"),e.popover.hide()},o.checkSession=function(){o.authData=a.ref().getAuth(),o.hide(),n.go("home")}}),starterControllers.controller("ModalCtrl",function(e,o,a){e.hide=function(){o.hide(),e.clickNext()},e.cancel=function(){o.cancel(),e.clickNext()},e.valuation=a}).controller("HomeCtrl",function(e,o,a,t,r,n,i,l,u,s){e.home={},e.home.valuation=1e5,e.score=0,e.Math=window.Math;var c=l.search();e.AdminMode=c.admin,e.map={},e.defaultzoom=15,e.stopRecording=!1;{var d=a.refHomes(),m=i(a.refHomes()).$asArray();a.refValuation()}m.$loaded().then(function(){var n=r.shuffle(m),i=0;if(e.property=n[i],e.likes=20,e.buildYr=2014-e.property.buildYr,e.hideDetail=!0,e.crowdvalue=e.property.crowdvalue,e.map={lat:e.property.lat,lng:e.property.lng,zoom:e.defaultzoom},e.markers={osloMarker:{lat:e.property.lat,lng:e.property.lng,focus:!0,draggable:!1}},e.home.minValuation=1e5,e.home.maxValuation=r.maxCondoValue(n[i].size),e.getDefaultValue=function(){u(function(){e.home.valuation=r.defaultCondoValue(n[i].size)},100)},e.getDefaultValue(),e.$broadcast("updateMap",e.map),u(function(){t.update(),e.$broadcast("updateTabs")},100),e.saveCaption=function(e,o){var a=d.child(n[i].$id),r="img/"+o+"/caption";a.child(r).set(e),u(function(){return t.update(),!0},100)},null!=o.authData){var l=a.refUsers().child(o.authData.uid+"/reputation");l.on("value",function(e){console.log("updated value here:"+e.val()),null!=o.authData&&(o.authData.reputation=e.val())},function(e){console.log("The read failed: "+e.code)})}e.valuation={},e.submitScore=function(){e.valuation.crowdvalue=e.property.crowdvalue,e.valuation.score=10-Math.abs(1.5*(e.crowdvalue-e.home.valuation)/e.crowdvalue*10),e.valuation.score<0&&(e.valuation.score=0),console.log("your score:"+e.valuation.score),e.stopRecording||a.saveValuation(e.home.valuation,e.authData,e.property)},e.postValuationPopup=function(){s.show({controller:"ModalCtrl",templateUrl:"view/buyer/modal.html",locals:{valuation:e.valuation}}).then(function(){e.clickNext()},function(){e.clickNext()})},e.clickNext=function(){t.slide(0),t.update();var o=n.length;e.hideDetail=!0,o-1>i?i++:i=0,e.property=n[i],e.likes=20,e.buildYr=2014-e.property.buildYr,e.hideDetail=!0,e.map.lat=e.property.lat,e.map.lng=e.property.lng,e.home.maxValuation=r.maxCondoValue(e.property.size),e.home.valuation=r.defaultCondoValue(e.property.size),e.$broadcast("updatemap",e.map),e.$broadcast("updateTabs",e.map)}})}).controller("AddHomeCtrl",["$scope","$http","$state","$firebase","fireBaseData","homeSchema",function(e,o,a,t,r,n){console.log("AddHomeCtrl"),a.go("addHome.addHome1");var i=r.refHomes(),l=t(i).$asArray();e.homeSchema=n,console.log(n),e.home={address:"",suiteNumber:"",city:"Toronto",province:"ON",postalCode:"",neighborhood:"",hideAddress:!1,ownerCertify:!1,homeType:e.homeSchema.homeTypes[0].value,buildingType:e.homeSchema.buildingTypes[0].value,buildingName:"",size:"",bedroomNum:e.homeSchema.bedRooms[0],bathroomNum:e.homeSchema.bathRooms[0],additionalSpace:[],parkingType:e.homeSchema.parkingType[0].value,parkingSpace:0,outdoorSpace:[],orientation:[],amenity:[],yearBuilt:"",maintenanceFee:"",houseId:-1,img:[]},e.uploadFiles=[],e.uploadFile=function(o){console.log(o[0]);var a=new FormData;a.append("file",o[0]),e.uploadFiles.push(a)},l.$loaded().then(function(){console.log("load homeref ....");var a=l.length,t=l[a-1].houseId;t>=a-1?(e.home.houseId=t+1,e.uploadFile=function(o,a){console.log(o),console.log("houseID: "+e.home.houseId),console.log(o[0]);var t=new FormData;t.append("file",o[0]),t.append("houseId",e.home.houseId),t.append("imageNum",a),e.uploadFiles.push(t)},e.submitForm=function(){for(var a=0;a<e.uploadFiles.length;a++){var t=e.uploadFiles[a];if(t){var r={url:"/upload",data:t,method:"POST",withCredentials:!0,headers:{"Content-Type":void 0},transformRequest:angular.identity};o(r).success(function(o){var a={caption:"",url:""};console.log("OK",o),a.url=o,e.home.img.push({caption:"",url:o}),l.$add(e.home).then(function(e){console.log("return is:  "+e)})}).error(function(e){console.log(e)})}else alert("No File Selected")}}):console.log("Error: house ID is not correct!")}),e.toggleSelection=function(e,o){var a=o.indexOf(e);a>-1?o.splice(a,1):o.push(e)},e.goToPg2=function(){console.log("gotopage2"),a.go("addHome.addHome2")},e.goToPg3=function(){console.log("goto hom3"),a.go("addHome.addHome3")},e.addhome=function(){console.log("add home"),a.go("addHome.addHome1")},e.submitHomes=function(){}}]),starterControllers.controller("MapCtrl",function(e){e.layers={baselayers:{mapbox_terrain:{name:"Mapbox Terrain",url:"http://api.tiles.mapbox.com/v4/{mapid}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiZG9uZ21pbmdsaXkiLCJhIjoiQ2tnWV9BayJ9.HEq2tSy-Jvid21sQNIUBRQ",type:"xyz",layerOptions:{apikey:"pk.eyJ1IjoiZG9uZ21pbmdsaXkiLCJhIjoiQ2tnWV9BayJ9.HEq2tSy-Jvid21sQNIUBRQ",mapid:"dongmingliy.kgb4m90f"}}}},e.defaults={scrollWheelZoom:!1},e.$on("updatemap",function(){e.map={lat:e.$parent.map.lat,lng:e.$parent.map.lng,zoom:e.$parent.defaultzoom},e.markers={osloMarker:{lat:e.$parent.map.lat,lng:e.$parent.map.lng,focus:!0,draggable:!1}}})}),starterControllers.controller("SliderCtrl",function(e,o,a){e.activeSlide=0,e.next=function(){a.next()},e.previous=function(){a.previous()},a.update();var t=function(){if(r=a.count(),e.curPhotoSlide=e.curInfoSlide="",n()){var o=e.activeSlide+1;e.curPhotoSlide=o+"/"+e.property.img.length}else if(i()){var o=e.activeSlide-e.property.img.length+1;e.curInfoSlide=o+"/3"}};e.slideHasChanged=function(o){a.slide(o),e.activeSlide=o,a.update(),t()};var r=0;e.curPhotoSlide=e.curInfoSlide="";var n=function(){return e.activeSlide<r-3-1},i=function(){return e.activeSlide<r-1&&e.activeSlide>=r-3-1}}),starterControllers.controller("LoginCtrl",function(e,o,a,t,r){function n(e){i(e),o.notify("Authenticated successfully!"),o.userid=e.id,o.authData=e,o.$apply(),o.hide(),a.go("home")}function i(e){e.updated=Firebase.ServerValue.TIMESTAMP;var o=r.refUsers();o.child(e.uid).set(e)}e.hideBackButton=!0,o.user={},o.user.username=e.user.username,o.user.password=e.user.password,e.signIn=function(e){return o.show("Logging In..."),e&&e.email&&e.password?void r.ref().authWithPassword({email:e.email,password:e.password},function(e,a){if(null===e)n(a);else{switch(e.code){case"INVALID_EMAIL":o.notify("The specified user account email is invalid.");break;case"INVALID_PASSWORD":o.notify("The specified user account password is incorrect.");break;case"INVALID_USER":o.notify("The specified user account does not exist.");break;default:o.notify("Error logging user in:",e)}o.hide(),o.notify("Error","Email or Password is incorrect!")}}):void o.notify("Error","Email or Password is incorrect!")},e.facebookLogin=function(){r.ref().authWithOAuthPopup("facebook",function(e,a){e?o.notify("Login Failed!",e):n(a)},{scope:"email,public_profile,user_games_activity,user_location"})},e.googleLogin=function(){r.ref().authWithOAuthPopup("google",function(e,a){e?o.notify("Login Failed!",e):n(a)},{scope:"email,profile"})},e.twitterLogin=function(){r.ref().authWithOAuthPopup("twitter",function(e,a){e?o.notify("Login Failed!",e):n(a)})}}).controller("RegisterCtrl",function(e,o,a,t,r,n,i){e.hideBackButton=!0,e.createUser=function(e){var t=e.firstname,l=e.surname,u=e.email,s=e.password;if(!(t&&l&&u&&s))return o.notify("Please enter valid credentials"),!1;o.show("Registering...");var c=n(r.ref()),d=function(t){t.updated=Firebase.ServerValue.TIMESTAMP;var n={};n.firstname=e.firstname,n.lastname=e.surname,t.user=n;var i=r.refUsers();i.child(t.uid).set(t,function(){o.hide(),a.go("login"),o.notify("Enter your email and password to login. ")})},m=function(){var e={url:"/sendmail",method:"POST",data:{email:u},headers:{"Content-Type":"application/json"}};i(e).success(function(e){console.log(e&&"sent"==e[0].status?"email sent to "+e[0].email:"email not sent")}).error(function(e){console.log(e)})};c.$createUser(u,s).then(function(){return c.$authWithPassword({email:u,password:s})}).then(d).then(m).catch(function(e){o.hide(),"INVALID_EMAIL"==e.code?o.notify("Error","Invalid Email."):"EMAIL_TAKEN"==e.code?o.notify("Error","Email already taken."):o.notify("Error","Oops. Something went wrong.")})}});